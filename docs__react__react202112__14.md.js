(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([[22],{"1yZ6":function(n,e,t){"use strict";t.r(e);var o=t("q1tI"),r=t.n(o),d=t("dEAq"),c=t("H1Ra"),a=r.a.memo((n=>{n.demos;return r.a.createElement(r.a.Fragment,null,r.a.createElement("div",{className:"markdown"},r.a.createElement("h1",{id:"context"},r.a.createElement(d["AnchorLink"],{to:"#context","aria-hidden":"true",tabIndex:-1},r.a.createElement("span",{className:"icon icon-link"})),"Context"),r.a.createElement("ul",null,r.a.createElement("li",null,"\u5728\u67d0\u4e9b\u573a\u666f\u4e0b\uff0c\u4f60\u60f3\u5728\u6574\u4e2a\u7ec4\u4ef6\u6811\u4e2d\u4f20\u9012\u6570\u636e\uff0c\u4f46\u5374\u4e0d\u60f3\u624b\u52a8\u5730\u5728\u6bcf\u4e00\u5c42\u4f20\u9012\u5c5e\u6027\u3002\u4f60\u53ef\u4ee5\u76f4\u63a5\u5728 React \u4e2d\u4f7f\u7528\u5f3a\u5927\u7684contextAPI\u89e3\u51b3\u4e0a\u8ff0\u95ee\u9898"),r.a.createElement("li",null,"\u5728\u4e00\u4e2a\u5178\u578b\u7684 React \u5e94\u7528\u4e2d\uff0c\u6570\u636e\u662f\u901a\u8fc7 props \u5c5e\u6027\u81ea\u4e0a\u800c\u4e0b\uff08\u7531\u7236\u53ca\u5b50\uff09\u8fdb\u884c\u4f20\u9012\u7684\uff0c\u4f46\u8fd9\u79cd\u505a\u6cd5\u5bf9\u4e8e\u67d0\u4e9b\u7c7b\u578b\u7684\u5c5e\u6027\u800c\u8a00\u662f\u6781\u5176\u7e41\u7410\u7684\uff08\u4f8b\u5982\uff1a\u5730\u533a\u504f\u597d\uff0cUI \u4e3b\u9898\uff09\uff0c\u8fd9\u4e9b\u5c5e\u6027\u662f\u5e94\u7528\u7a0b\u5e8f\u4e2d\u8bb8\u591a\u7ec4\u4ef6\u90fd\u9700\u8981\u7684\u3002Context \u63d0\u4f9b\u4e86\u4e00\u79cd\u5728\u7ec4\u4ef6\u4e4b\u95f4\u5171\u4eab\u6b64\u7c7b\u503c\u7684\u65b9\u5f0f\uff0c\u800c\u4e0d\u5fc5\u663e\u5f0f\u5730\u901a\u8fc7\u7ec4\u4ef6\u6811\u7684\u9010\u5c42\u4f20\u9012 props")),r.a.createElement("p",null,r.a.createElement("img",{src:"http://wuxiao-tech-doc.oss-cn-hangzhou.aliyuncs.com/2022-01-30-150817.gif",alt:"contextapi_1626532435193"})),r.a.createElement("h2",{id:"srcindexjs"},r.a.createElement(d["AnchorLink"],{to:"#srcindexjs","aria-hidden":"true",tabIndex:-1},r.a.createElement("span",{className:"icon icon-link"})),"src\\index.js"),r.a.createElement(c["a"],{code:"import React from './react';\nimport ReactDOM from './react-dom';\nlet ThemeContext = React.createContext();\nconsole.log(ThemeContext);\nconst { Provider, Consumer } = ThemeContext;\nlet style = { margin: '5px', padding: '5px' };\nfunction Title(props) {\n  console.log('Title');\n  return (\n    <Consumer>\n      {\n        (contextValue) => (\n          <div style={{ ...style, border: `5px solid ${contextValue.color}` }}>\n            Title\n          </div>\n        )\n      }\n    </Consumer>\n  )\n}\nclass Header extends React.Component {\n  static contextType = ThemeContext\n  render() {\n    console.log('Header');\n    return (\n      <div style={{ ...style, border: `5px solid ${this.context.color}` }}>\n        Header\n        <Title />\n      </div>\n    )\n  }\n}\nfunction Content() {\n  console.log('Content');\n  return (\n    <Consumer>\n      {\n        (contextValue) => (\n          <div style={{ ...style, border: `5px solid ${contextValue.color}` }}>\n            Content\n            <button style={{ color: 'red' }} onClick={() => contextValue.changeColor('red')}>\u53d8\u7ea2</button>\n            <button style={{ color: 'green' }} onClick={() => contextValue.changeColor('green')}>\u53d8\u7eff</button>\n          </div>\n        )\n      }\n    </Consumer>\n  )\n}\nclass Main extends React.Component {\n  static contextType = ThemeContext\n  render() {\n    console.log('Main');\n    return (\n      <div style={{ ...style, border: `5px solid ${this.context.color}` }}>\n        Main\n        <Content />\n      </div>\n    )\n  }\n}\n\nclass Page extends React.Component {\n  constructor(props) {\n    super(props);\n    this.state = { color: 'black' };\n  }\n  changeColor = (color) => {\n    this.setState({ color });\n  }\n  render() {\n\n    console.log('Page');\n    let contextValue = { color: this.state.color, changeColor: this.changeColor };\n    return (\n      <Provider value={contextValue}>\n        <div style={{ ...style, width: '250px', border: `5px solid ${this.state.color}` }}>\n          Page\n          <Header />\n          <Main />\n        </div>\n      </Provider >\n    )\n  }\n}\nReactDOM.render(\n  <Page />,\n  document.getElementById('root')\n);",lang:"js"}),r.a.createElement("h2",{id:"srcconstantsjs"},r.a.createElement(d["AnchorLink"],{to:"#srcconstantsjs","aria-hidden":"true",tabIndex:-1},r.a.createElement("span",{className:"icon icon-link"})),"src\\constants.js"),r.a.createElement(c["a"],{code:"export const REACT_TEXT = Symbol('REACT_TEXT');\nexport const REACT_FORWARD_REF_TYPE = Symbol('react.forward_ref');\n\nexport const PLACEMENT = 'PLACEMENT';\nexport const MOVE = 'MOVE';\n\n+export const REACT_PROVIDER = Symbol('react.provider');\n+export const REACT_CONTEXT = Symbol('react.context');",lang:"diff"}),r.a.createElement("h2",{id:"srccomponentjs"},r.a.createElement(d["AnchorLink"],{to:"#srccomponentjs","aria-hidden":"true",tabIndex:-1},r.a.createElement("span",{className:"icon icon-link"})),"src\\Component.js"),r.a.createElement(c["a"],{code:"// ...\nexport class Component {\n  static isReactComponent = true\n  constructor(props) {\n    this.props = props\n    this.state = {}\n    this.updater = new Updater(this)\n  }\n  setState(partialState) {\n    this.updater.addState(partialState)\n  }\n  // \u8ba9\u7c7b\u7ec4\u4ef6\u5f3a\u884c\u66f4\u65b0\n  forceUpdate() {\n    // \u83b7\u53d6\u6b64\u7ec4\u4ef6\u4e0a\u4e00\u6b21 render \u6e32\u67d3\u51fa\u6765\u7684\u865a\u62df DOM\n    let oldRenderVdom = this.oldRenderVdom;\n    // \u83b7\u53d6\u865a\u62dfDOM\u5bf9\u5e94\u7684\u771f\u5b9eDOM oldRenderVdom.dom\n    let oldDOM = findDOM(oldRenderVdom)\n+    // \u66f4\u65b0\u7c7b\u7ec4\u4ef6\u7684\u65f6\u5019\u8981\u91cd\u65b0\u53d6\u503c\n+    if (this.constructor.contextType) {\n+      this.context = this.constructor.contextType._currentValue\n+    }\n    if (this.constructor.getDerivedStateFromProps) {\n      let newState = this.constructor.getDerivedStateFromProps(this.props, this.state)\n      if (newState)\n        this.state = {...this.state, ...newState}\n    }\n    let snapshot = this.getSnapshotBeforeUpdate && this.getSnapshotBeforeUpdate()\n    // \u91cd\u65b0\u6267\u884c render \u5f97\u5230\u65b0\u7684\u865a\u62dfDOM\n    let newRenderVdom = this.render()\n    // \u628a\u8001\u5f97\u865a\u62dfDOM\u548c\u65b0\u7684\u865a\u62dfDOM\u8fdb\u884c\u5bf9\u6bd4\uff0c\u5bf9\u6bd4\u5f97\u5230\u7684\u5dee\u5f02\u66f4\u65b0\u5230\u771f\u5b9eDOM\n    compareTwoVdom(oldDOM.parentNode, oldRenderVdom, newRenderVdom)\n    this.oldRenderVdom = newRenderVdom\n    if(this.componentDidUpdate) {\n      this.componentDidUpdate(this.props, this.state, snapshot)\n    }\n  }\n}",lang:"diff"}),r.a.createElement("h2",{id:"srcreactjs"},r.a.createElement(d["AnchorLink"],{to:"#srcreactjs","aria-hidden":"true",tabIndex:-1},r.a.createElement("span",{className:"icon icon-link"})),"src\\react.js"),r.a.createElement(c["a"],{code:'+ import {REACT_CONTEXT, REACT_ELEMENT, REACT_FORWARD_REF_TYPE, REACT_PROVIDER} from "./constants";\nimport { wrapToVdom } from "./utils";\nimport { Component } from "./Component";\n\n// ...\n\n+ function createContext() {\n+   let context = { $$typeof: REACT_CONTEXT }\n+   context.Provider = {\n+     $$typeof: REACT_PROVIDER,\n+     _context: context\n+   }\n+   context.Consumer = {\n+     $$typeof: REACT_CONTEXT,\n+     _context: context\n+   }\n+   return context;\n+ }\n\nconst React = {\n  createElement,\n  Component,\n  createRef,\n  forwardRef,\n+  createContext,\n}\nexport default React',lang:"diff"}),r.a.createElement("h2",{id:"srcreact-dom"},r.a.createElement(d["AnchorLink"],{to:"#srcreact-dom","aria-hidden":"true",tabIndex:-1},r.a.createElement("span",{className:"icon icon-link"})),"src\\react-dom"),r.a.createElement(c["a"],{code:"+ import {MOVE, PLACEMENT, REACT_CONTEXT, REACT_FORWARD_REF_TYPE, REACT_PROVIDER, REACT_TEXT} from \"./constants\";\nimport {addEvent} from \"./event\";\n\n// ...\n/**\n * \u628a\u865a\u62df DOM \u8f6c\u6362\u6210\u771f\u5b9e DOM\n * @param vdom \u865a\u62dfDOM\n */\nfunction createDOM(vdom) {\n  let { type, props, ref } = vdom;\n  let dom;  // \u771f\u5b9eDOM\n\n  if (type && type.$$typeof === REACT_FORWARD_REF_TYPE) { // \u8f6c\u53d1\u7ec4\u4ef6\n    return mountForwardComponent(vdom);\n+  } else if(type && type.$$typeof === REACT_PROVIDER) {\n+    return mountProviderComponent(vdom)\n+  } else if(type && type.$$typeof === REACT_CONTEXT) {\n+    return mountContextComponent(vdom)\n  } else if (type === REACT_TEXT) { // \u6587\u672c\u7ec4\u4ef6\n    dom = document.createTextNode(props)\n  } else if (typeof type === \"function\") {\n    if (type.isReactComponent) { // \u7c7b\u7ec4\u4ef6\n      return mountClassComponent(vdom);\n    } else { // \u51fd\u6570\u7ec4\u4ef6\n      return mountFunctionComponent(vdom)\n    }\n  } else {\n    dom = document.createElement(type)\n  }\n  if (props) {\n    updateProps(dom, {}, props)\n    const children = props.children\n    if (typeof children === 'object' && children.type) {\n      children.mountIndex = 0\n      mount(children, dom)\n    } else if (Array.isArray(children)) {\n      reconcileChildren(children, dom);\n    }\n  }\n  \n  // ...\n  \n+ function mountProviderComponent(vdom) {\n+   let { type, props } = vdom;\n+   let context = type._context\n+   context._currentValue = props.value;\n+   let renderVdom = props.children;\n+   vdom.oldRenderVdom = renderVdom;\n+   return createDOM(renderVdom)\n+ }\n+ \n+ function mountContextComponent(vdom) {\n+   let { type, props } = vdom;\n+   let context = type._context\n+   let renderVdom = props.children(context._currentValue);\n+   vdom.oldRenderVdom = renderVdom;\n+   return createDOM(renderVdom)\n+ }\n\nfunction mountForwardComponent(vdom) {\n  let { type, props, ref } = vdom;\n  let renderVdom = type.render(props, ref)\n  vdom.oldRenderVdom = renderVdom\n  return createDOM(renderVdom)\n}\n\n// ...\n\nfunction mountClassComponent(vdom) {\n  // \u83b7\u53d6\u51fd\u6570\u672c\u8eab\n  let { type: ClassComponent, props, ref } = vdom;\n  // \u628a\u5c5e\u6027\u5bf9\u8c61\u4f20\u9012\u7ed9\u51fd\u6570\u6267\u884c\uff0c\u8fd4\u56de\u8981\u6e32\u67d3\u7684\u865a\u62dfDOM\n  let classInstance = new ClassComponent(props);\n+  if (ClassComponent.contextType) {\n+    classInstance.context = ClassComponent.contextType._currentValue\n+  }\n  // \u7ed9\u865a\u62dfDOM\u6dfb\u52a0\u4e00\u4e2a\u5c5e\u6027 classInstance\n  vdom.classInstance = classInstance\n  // \u8ba9 ref.current \u6307\u5411\u7c7b\u7ec4\u4ef6\u7684\u5b9e\u4f8b\n  if (ref) ref.current = classInstance;\n  if (classInstance.componentWillMount) {\n    classInstance.componentWillMount()\n  }\n  let renderVdom = classInstance.render();\n  // \u628a\u4e0a\u4e00\u6b21render\u6e32\u67d3\u5f97\u5230\u7684\u865a\u62dfDOM\n  classInstance.oldRenderVdom = renderVdom\n  let dom = createDOM(renderVdom)\n  if (classInstance.componentDidMount) {\n    dom.componentDidMount = classInstance.componentDidMount.bind(classInstance)\n  }\n  return dom\n}\n\n// ...\n\n/**\n * \u6df1\u5ea6\u6bd4\u8f83\u65b0\u8001\u865a\u62dfDOM\u7684\u5dee\u5f02\uff0c\u628a\u5dee\u5f02\u540c\u6b65\u5230\u771f\u5b9eDOM\u4e0a\n * @param oldVdom\n * @param newVdom\n */\nfunction updateElement(oldVdom, newVdom) {\n+  if (oldVdom.type.$$typeof === REACT_CONTEXT) {\n+    updateContextComponent(oldVdom, newVdom)\n+  } else if (oldVdom.type.$$typeof === REACT_PROVIDER) {\n+    updateProviderComponent(oldVdom, newVdom)\n+  } else if (oldVdom.type === REACT_TEXT) {  // \u5982\u679c\u662f\u6587\u672c\u8282\u70b9\u7684\u8bdd\n    let currentDOM = newVdom.dom = findDOM(oldVdom)\n    if (oldVdom.props !== newVdom.props) {\n      currentDOM.textContent = newVdom.props\n    }\n  } else if (typeof oldVdom.type === 'string') {\n    let currentDOM = newVdom.dom = findDOM(oldVdom)\n    updateProps(currentDOM, oldVdom.props, newVdom.props)\n    updateChildren(currentDOM, oldVdom.props.children, newVdom.props.children)\n  } else if (typeof oldVdom.type === 'function') {\n    // \u8bf4\u660e\u8fd9\u662f\u4e00\u4e2a\u7c7b\u7ec4\u4ef6\n    if (oldVdom.type.isReactComponent) {\n      updateClassComponent(oldVdom, newVdom)\n    } else {\n      updateFunctionComponent(oldVdom, newVdom)\n    }\n  }\n}\n\n// ...\n+ function updateProviderComponent(oldVdom, newVdom) {\n+   let currentDOM = findDOM(oldVdom)\n+   if (!currentDOM) return;\n+   let parentDOM = currentDOM.parentNode;\n+   let { type, props } = newVdom;\n+   let context = type._context;\n+   context._currentValue = props.value;\n+   let newRenderVdom = props.children\n+   compareTwoVdom(parentDOM, oldVdom.oldRenderVdom, newRenderVdom)\n+   newVdom.oldRenderVdom = newRenderVdom\n+ }\n+ \n+ function updateContextComponent(oldVdom, newVdom) {\n+   let currentDOM = findDOM(oldVdom)\n+   if (!currentDOM) return;\n+   let parentDOM = currentDOM.parentNode;\n+   let { type, props } = newVdom;\n+   let context = type._context;\n+   let newRenderVdom = props.children(context._currentValue)\n+   compareTwoVdom(parentDOM, oldVdom.oldRenderVdom, newRenderVdom)\n+   newVdom.oldRenderVdom = newRenderVdom\n+ }",lang:"diff"})))}));e["default"]=n=>{var e=r.a.useContext(d["context"]),t=e.demos;return r.a.useEffect((()=>{var e;null!==n&&void 0!==n&&null!==(e=n.location)&&void 0!==e&&e.hash&&d["AnchorLink"].scrollToAnchor(decodeURIComponent(n.location.hash.slice(1)))}),[]),r.a.createElement(a,{demos:t})}}}]);