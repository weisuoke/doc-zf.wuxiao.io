(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([[25],{dtcM:function(n,e,o){"use strict";o.r(e);var t=o("q1tI"),r=o.n(t),a=o("dEAq"),m=o("H1Ra"),d=r.a.memo((n=>{n.demos;return r.a.createElement(r.a.Fragment,null,r.a.createElement("div",{className:"markdown"},r.a.createElement("h1",{id:"\u6027\u80fd\u4f18\u5316"},r.a.createElement(a["AnchorLink"],{to:"#\u6027\u80fd\u4f18\u5316","aria-hidden":"true",tabIndex:-1},r.a.createElement("span",{className:"icon icon-link"})),"\u6027\u80fd\u4f18\u5316"),r.a.createElement("h2",{id:"srcindexjs"},r.a.createElement(a["AnchorLink"],{to:"#srcindexjs","aria-hidden":"true",tabIndex:-1},r.a.createElement("span",{className:"icon icon-link"})),"src\\index.js"),r.a.createElement(m["a"],{code:"import React from './react';\nimport ReactDOM from './react-dom';\nclass ClassCounter extends React.PureComponent {\n    render() {\n        console.log('ClassCounter render');\n        return <div>ClassCounter:{this.props.count}</div>\n    }\n}\nfunction FunctionCounter(props) {\n    console.log('FunctionCounter render'); debugger\n    return <div>FunctionCounter:{props.count}</div>\n}\nconst MemoFunctionCounter = React.memo(FunctionCounter);\nclass App extends React.Component {\n    state = { number: 0 }\n    amountRef = React.createRef()\n    handleClick = () => {\n        let nextNumber = this.state.number + parseInt(this.amountRef.current.value);\n        this.setState({ number: nextNumber });\n    }\n    render() {\n        return (\n            <div>\n                <ClassCounter count={this.state.number} />\n                <MemoFunctionCounter count={this.state.number} />\n                <input ref={this.amountRef} />\n                <button onClick={this.handleClick}>+</button>\n            </div>\n        )\n    }\n}\nReactDOM.render(\n    <App />, document.getElementById('root'));",lang:"js"}),r.a.createElement("h2",{id:"srcconstantsjs"},r.a.createElement(a["AnchorLink"],{to:"#srcconstantsjs","aria-hidden":"true",tabIndex:-1},r.a.createElement("span",{className:"icon icon-link"})),"src\\constants.js"),r.a.createElement(m["a"],{code:"export const REACT_TEXT = Symbol('REACT_TEXT');\nexport const REACT_FORWARD_REF_TYPE = Symbol('react.forward_ref');\n\nexport const PLACEMENT = 'PLACEMENT';\nexport const MOVE = 'MOVE';\n\nexport const REACT_CONTEXT = Symbol('react.context');\nexport const REACT_PROVIDER = Symbol('react.provider');\n+export const REACT_MEMO = Symbol('react.memo')",lang:"diff"}),r.a.createElement("h2",{id:"srcutilsjs"},r.a.createElement(a["AnchorLink"],{to:"#srcutilsjs","aria-hidden":"true",tabIndex:-1},r.a.createElement("span",{className:"icon icon-link"})),"src\\utils.js"),r.a.createElement(m["a"],{code:"import { REACT_TEXT } from \"./constants\";\n\n/**\n * \u628a\u865a\u62df DOM \u8282\u70b9\u8fdb\u884c\u5305\u88c5\n * \u5982\u679c\u6b64\u865a\u62dfDOM\u662f\u4e00\u4e2a\u6587\u672c\uff0c\u6bd4\u5982\u8bf4\u662f\u5b57\u7b26\u4e32\u6216\u8005\u6570\u5b57\uff0c\u5305\u88c5\u6210\u4e00\u4e2a\u865a\u62dfDOM\u8282\u70b9\u5bf9\u8c61\n * @param element \u865a\u62dfDOM\n * @returns {{type: symbol, props: {content: (string|number)}}|*}\n */\nexport function wrapToVdom(element) {\n  return typeof element === 'string' || typeof element === 'number' ? {\n    type: REACT_TEXT, props: element\n  } : element\n}\n\n/**\n * \u6d45\u6bd4\u8f83\u4e24\u4e2a\u5bf9\u8c61\n * @param obj1 \u5bf9\u8c611\n * @param obj2 \u5bf9\u8c612\n */\n+ export function shallowEqual(obj1, obj2) {\n+   if (obj1 === obj2) {\n+     return true\n+   }\n+   if (typeof obj1 !== 'object' || obj1 === null || typeof obj2 !== 'object' || obj2 === null) {\n+     return false\n+   }\n+   // \u5982\u679c\u90fd\u662f\u5bf9\u8c61\uff0c\u5e76\u4e14\u5c5e\u6027\u90fd\u662f\u5b58\u5728\u7684\n+   let keys1 = Object.keys(obj1);\n+   let keys2 = Object.keys(obj2);\n+   if (keys1.length !== keys2.length) {\n+     return false\n+   }\n+   for (let key of keys1) {\n+     if (!obj2.hasOwnProperty(key) || obj1[key] !== obj2[key]) {\n+       return false;\n+     }\n+   }\n+ \n+   return true\n+ }",lang:"diff"}),r.a.createElement("h2",{id:"srcreactjs"},r.a.createElement(a["AnchorLink"],{to:"#srcreactjs","aria-hidden":"true",tabIndex:-1},r.a.createElement("span",{className:"icon icon-link"})),"src/react.js"),r.a.createElement(m["a"],{code:'+ import {REACT_CONTEXT, REACT_ELEMENT, REACT_FORWARD_REF_TYPE, REACT_MEMO, REACT_PROVIDER} from "./constants";\n+ import {shallowEqual, wrapToVdom} from "./utils";\n+ import { Component, PureComponent } from "./Component";\n\n// ...\n\n+ /**\n+  *  \u8fd4\u56de\u4e00\u4e2a\u53ef\u4ee5\u5728\u5c5e\u6027\u4e0d\u53d8\u7684\u65f6\u5019\u4e0d\u91cd\u65b0\u6e32\u67d3\u7684\u7ec4\u4ef6\n+  * @param type \u51fd\u6570\u7ec4\u4ef6\n+  * @param compare \u6bd4\u8f83\u5c5e\u6027\u662f\u5426\u76f8\u540c\u7684\u65b9\u6cd5\n+  */\n+ function memo(type, compare = shallowEqual) {\n+   return {\n+     $$typeof: REACT_MEMO,\n+     compare,\n+     type\n+   }\n+ }\n\nconst React = {\n  createElement,\n  Component,\n  createRef,\n  forwardRef,\n  createContext,\n  cloneElement,\n+  PureComponent,\n+  memo\n}\nexport default React',lang:"diff"}),r.a.createElement("h2",{id:"srccomponentjs"},r.a.createElement(a["AnchorLink"],{to:"#srccomponentjs","aria-hidden":"true",tabIndex:-1},r.a.createElement("span",{className:"icon icon-link"})),"src/Component.js"),r.a.createElement(m["a"],{code:"+ export class PureComponent extends Component {\n+   shouldComponentUpdate(newProps, nextState) {\n+     // \u5982\u679c\u65b0\u5c5e\u6027\u548c\u8001\u5c5e\u6027\u4e0d\u76f8\u7b49\u6216\u8005\u65b0\u72b6\u6001\u548c\u8001\u72b6\u6001\u4e0d\u76f8\u7b49\n+     return !shallowEqual(this.props, newProps) || !shallowEqual(this.state, nextState)\n+   }\n+ }",lang:"diff"}),r.a.createElement("h2",{id:"srcreact-domjs"},r.a.createElement(a["AnchorLink"],{to:"#srcreact-domjs","aria-hidden":"true",tabIndex:-1},r.a.createElement("span",{className:"icon icon-link"})),"src/react-dom.js"),r.a.createElement(m["a"],{code:"import {\n  MOVE,\n  PLACEMENT,\n  REACT_CONTEXT,\n  REACT_FORWARD_REF_TYPE,\n+  REACT_MEMO,\n  REACT_PROVIDER,\n  REACT_TEXT\n} from \"./constants\";\n\n// ...\n\n/**\n * \u628a\u865a\u62df DOM \u8f6c\u6362\u6210\u771f\u5b9e DOM\n * @param vdom \u865a\u62dfDOM\n */\nfunction createDOM(vdom) {\n  let { type, props, ref } = vdom;\n  let dom;  // \u771f\u5b9eDOM\n\n+  if (type && type.$$typeof === REACT_MEMO) {\n+    return mountMemoComponent(vdom)\n+  } else if (type && type.$$typeof === REACT_FORWARD_REF_TYPE) { // \u8f6c\u53d1\u7ec4\u4ef6\n    return mountForwardComponent(vdom);\n  } else if(type && type.$$typeof === REACT_PROVIDER) {\n    return mountProviderComponent(vdom)\n  } else if(type && type.$$typeof === REACT_CONTEXT) {\n    return mountContextComponent(vdom)\n  } else if (type === REACT_TEXT) { // \u6587\u672c\u7ec4\u4ef6\n    dom = document.createTextNode(props)\n  } else if (typeof type === \"function\") {\n    if (type.isReactComponent) { // \u7c7b\u7ec4\u4ef6\n      return mountClassComponent(vdom);\n    } else { // \u51fd\u6570\u7ec4\u4ef6\n      return mountFunctionComponent(vdom)\n    }\n  } else {\n    dom = document.createElement(type)\n  }\n  if (props) {\n    updateProps(dom, {}, props)\n    const children = props.children\n    if (typeof children === 'object' && children.type) {\n      children.mountIndex = 0\n      mount(children, dom)\n    } else if (Array.isArray(children)) {\n      reconcileChildren(children, dom);\n    }\n  }\n\n  vdom.dom = dom;\n  if (ref) ref.current = dom;\n  return dom;\n}\n\n+ function mountMemoComponent(vdom) {\n+   let { type: { type: functionComponent }, props } = vdom;\n+   let renderVdom = functionComponent(props)\n+   // \u8bb0\u5f55\u4e0b\u8001\u7684\u5c5e\u6027\u5bf9\u8c61\n+   vdom.prevProps = props\n+   vdom.oldRenderVdom = renderVdom;\n+   return createDOM(renderVdom)\n+ }\n\n// ...\n\n/**\n * \u6df1\u5ea6\u6bd4\u8f83\u65b0\u8001\u865a\u62dfDOM\u7684\u5dee\u5f02\uff0c\u628a\u5dee\u5f02\u540c\u6b65\u5230\u771f\u5b9eDOM\u4e0a\n * @param oldVdom\n * @param newVdom\n */\nfunction updateElement(oldVdom, newVdom) {\n+  if (oldVdom.type && oldVdom.type.$$typeof === REACT_MEMO) {\n+    updateMemoComponent(oldVdom, newVdom)\n+  } else if (oldVdom.type.$$typeof === REACT_CONTEXT) {\n    updateContextComponent(oldVdom, newVdom)\n  } else if (oldVdom.type.$$typeof === REACT_PROVIDER) {\n    updateProviderComponent(oldVdom, newVdom)\n  } else if (oldVdom.type === REACT_TEXT) {  // \u5982\u679c\u662f\u6587\u672c\u8282\u70b9\u7684\u8bdd\n    let currentDOM = newVdom.dom = findDOM(oldVdom)\n    if (oldVdom.props !== newVdom.props) {\n      currentDOM.textContent = newVdom.props\n    }\n  } else if (typeof oldVdom.type === 'string') {\n    let currentDOM = newVdom.dom = findDOM(oldVdom)\n    updateProps(currentDOM, oldVdom.props, newVdom.props)\n    updateChildren(currentDOM, oldVdom.props.children, newVdom.props.children)\n  } else if (typeof oldVdom.type === 'function') {\n    // \u8bf4\u660e\u8fd9\u662f\u4e00\u4e2a\u7c7b\u7ec4\u4ef6\n    if (oldVdom.type.isReactComponent) {\n      updateClassComponent(oldVdom, newVdom)\n    } else {\n      updateFunctionComponent(oldVdom, newVdom)\n    }\n  }\n}\n\n+ function updateMemoComponent(oldVdom, newVdom) {\n+   // 1. \u83b7\u53d6\u8001\u5f97\u865a\u62df DOM \u7684\u6bd4\u8f83\u65b9\u6cd5\u548c\u8001\u7684\u5c5e\u6027\u5bf9\u8c61\n+   let { type: { compare }, prevProps } = oldVdom;\n+   // 2. \u6bd4\u8f83\u8001\u5f97\u5c5e\u6027\u5bf9\u8c61\u548c\u65b0\u7684\u865a\u62dfDOM\u7684\u5c5e\u6027\u5bf9\u8c61\n+   if (!compare(prevProps, newVdom.props)) {\n+     // \u5982\u679c\u4e0d\u4e00\u6837\uff0c\u5c31\u8981\u91cd\u65b0\u6e32\u67d3\uff0c\u6267\u884cDOM-DIFF\n+     let currentDOM = findDOM(oldVdom)\n+     if (!currentDOM) return;\n+     let parentDOM = currentDOM.parentNode;\n+     let { type: { type: FunctionComponent }, props } = newVdom;\n+     let newRenderVdom = FunctionComponent(props)\n+     compareTwoVdom(parentDOM, oldVdom.oldRenderVdom, newRenderVdom)\n+     newVdom.prevProps = props;\n+     newVdom.oldRenderVdom = newRenderVdom\n+   } else {\n+     newVdom.prevProps = prevProps\n+     newVdom.oldRenderVdom = oldVdom.oldRenderVdom\n+   }\n+ }",lang:"diff"})))}));e["default"]=n=>{var e=r.a.useContext(a["context"]),o=e.demos;return r.a.useEffect((()=>{var e;null!==n&&void 0!==n&&null!==(e=n.location)&&void 0!==e&&e.hash&&a["AnchorLink"].scrollToAnchor(decodeURIComponent(n.location.hash.slice(1)))}),[]),r.a.createElement(d,{demos:o})}}}]);