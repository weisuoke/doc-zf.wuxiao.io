(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([[51],{X8n7:function(e,t,n){"use strict";n.r(t);var a=n("q1tI"),s=n.n(a),l=n("dEAq"),r=n("H1Ra"),o=s.a.memo((e=>{e.demos;return s.a.createElement(s.a.Fragment,null,s.a.createElement("div",{className:"markdown"},s.a.createElement("h1",{id:"\u5b9e\u73b0\u6279\u91cf\u66f4\u65b0"},s.a.createElement(l["AnchorLink"],{to:"#\u5b9e\u73b0\u6279\u91cf\u66f4\u65b0","aria-hidden":"true",tabIndex:-1},s.a.createElement("span",{className:"icon icon-link"})),"\u5b9e\u73b0\u6279\u91cf\u66f4\u65b0"),s.a.createElement("ul",null,s.a.createElement("li",null,"State \u7684\u66f4\u65b0\u4f1a\u88ab\u5408\u5e76 \u5f53\u4f60\u8c03\u7528 setState() \u7684\u65f6\u5019\uff0cReact \u4f1a\u628a\u4f60\u63d0\u4f9b\u7684\u5bf9\u8c61\u5408\u5e76\u5230\u5f53\u524d\u7684 state"),s.a.createElement("li",null,"State \u7684\u66f4\u65b0\u53ef\u80fd\u662f\u5f02\u6b65\u7684",s.a.createElement("ul",null,s.a.createElement("li",null,"\u51fa\u4e8e\u6027\u80fd\u8003\u8651\uff0cReact \u53ef\u80fd\u4f1a\u628a\u591a\u4e2a setState() \u8c03\u7528\u5408\u5e76\u6210\u4e00\u4e2a\u8c03\u7528"),s.a.createElement("li",null,"\u56e0\u4e3a this.props \u548c this.state \u53ef\u80fd\u4f1a\u5f02\u6b65\u66f4\u65b0\uff0c\u6240\u4ee5\u4f60\u4e0d\u8981\u4f9d\u8d56\u4ed6\u4eec\u7684\u503c\u6765\u66f4\u65b0\u4e0b\u4e00\u4e2a\u72b6\u6001"),s.a.createElement("li",null,"\u53ef\u4ee5\u8ba9 setState() \u63a5\u6536\u4e00\u4e2a\u51fd\u6570\u800c\u4e0d\u662f\u4e00\u4e2a\u5bf9\u8c61\u3002\u8fd9\u4e2a\u51fd\u6570\u7528\u4e0a\u4e00\u4e2a state \u4f5c\u4e3a\u7b2c\u4e00\u4e2a\u53c2\u6570")))),s.a.createElement("p",null,"src/index.js"),s.a.createElement(r["a"],{code:'import React from "./react";\nimport ReactDOM from "./react-dom";\nimport {updateQueue} from "./Component";\n\n/**\n * 1. \u5728 React \u80fd\u7ba1\u7406\u7684\u65b9\u6cd5\u66f4\u65b0\u662f\u5f02\u6b65\u7684\uff0c\u6279\u91cf\u7684\n * 2. \u5728 React \u7ba1\u7406\u4e0d\u5230\u7684\u5730\u65b9\u66f4\u65b0\u5c31\u662f\u540c\u6b65\u7684\n */\nclass Counter extends React.Component {\n  constructor(props) {\n    super(props);\n    this.state = { number: 0 };\n  }\n  handleClick = () => {\n    updateQueue.isBatchingUpdate = true\n    // \u5728 handleClick \u65b9\u6cd5\u4e2d\u6267\u884c\u662f\u6279\u91cf\u7684\uff0c\u662f\u5f02\u6b65\u7684\uff0c\u4f1a\u5728\u65b9\u6cd5\u6267\u884c\u7ed3\u675f\u540e\u518d\u66f4\u65b0\n    this.setState({ number: this.state.number + 1 });\n    console.log(this.state.number);\n    this.setState({ number: this.state.number + 1 });\n    console.log(this.state.number);\n    setTimeout(() => {\n      // \u5728 setTimeout \u91cc\u66f4\u65b0\u662f\u540c\u6b65\u7684\n      this.setState({ number: this.state.number + 1 });\n      console.log(this.state.number);\n      this.setState({ number: this.state.number + 1 });\n      console.log(this.state.number);\n    })\n    updateQueue.batchUpdate()\n  }\n  render() {\n    return (\n      <div>\n        <p>{this.props.title}</p>\n        <p>number:{this.state.number}</p>\n        <button onClick={this.handleClick}>+</button>\n      </div>\n    )\n  }\n}\nReactDOM.render(<Counter title="\u8ba1\u6570\u5668" />, document.getElementById("root"));',lang:"js"}),s.a.createElement("p",null,"src/Component.js"),s.a.createElement(r["a"],{code:'import { findDOM, compareTwoVdom } from "./react-dom";\n\n+ export let updateQueue = {\n+   isBatchingUpdate: false,  // \u66f4\u65b0\u961f\u91cc\u4e2d\u6709\u4e00\u4e2a\u6807\u8bc6\uff0c\u662f\u5426\u8981\u6267\u884c\u6279\u91cf\u66f4\u65b0\n+   updaters: new Set(),  // Updater\u5b9e\u4f8b\u7684\u96c6\u5408\n+   batchUpdate() {\n+     for(let updater of updateQueue.updaters) {\n+       updater.updateComponent()\n+     }\n+     // \u91cd\u7f6e\u4e3afalse\n+     updateQueue.isBatchingUpdate = false\n+     // \u6e05\u7a7aupdater\u96c6\u5408\n+     updateQueue.updaters.clear()\n+   }\n+ }\n\nclass Updater{\n  constructor(classInstance) {\n    // \u7c7b\u7ec4\u4ef6\u5b9e\u4f8b\n    this.classInstance = classInstance\n    // \u7b49\u5f85\u66f4\u65b0\u7684\u72b6\u6001\n    this.pendingStates = []\n    // \u66f4\u65b0\u540e\u7684\u56de\u8c03\n    this.callbacks = []\n  }\n  addState(partialState, callback) {\n    this.pendingStates.push(partialState)\n    if (typeof callback === \'function\') {\n      this.callbacks.push(callback)\n    }\n    // \u89e6\u53d1\u66f4\u65b0\n    this.emitUpdate();\n  }\n  emitUpdate() {\n+    // \u5982\u679c\u6279\u91cf\u66f4\u65b0\u53ea\u9700\u8981\u628a updater \u6dfb\u52a0\u5230\u961f\u5217\u91cc\u3002\u4e0d\u9700\u8981\u5b9e\u65f6\u66f4\u65b0\n+    if (updateQueue.isBatchingUpdate) {\n+      updateQueue.updaters.add(this)\n+    } else {\n+      // \u5426\u5219\u5c31\u76f4\u63a5\u66f4\u65b0\n+      this.updateComponent();\n+    }\n  }\n  updateComponent() {\n    let { classInstance, pendingStates, callbacks } = this;\n    // \u957f\u5ea6\u5927\u4e8e 0\uff0c\u8bf4\u660e\u5f53\u524d\u6709\u6b63\u5728\u51c6\u5907\u8981\u66f4\u65b0\u7684\u5206\u72b6\u6001\u3002\n    if (pendingStates.length > 0) {\n      shouldUpdate(classInstance, this.getState())\n    }\n    if (callbacks.length > 0) {\n      callbacks.forEach(callback => callback())\n      callbacks.length = 0\n    }\n  }\n  // \u8fd4\u56de\u65b0\u72b6\u6001\n  getState() {\n    let { classInstance, pendingStates } = this;\n    // \u5148\u83b7\u53d6\u8001\u72b6\u6001\n    let { state } = classInstance;\n    // \u7528\u8001\u72b6\u6001\u5408\u5e76\u65b0\u72b6\u6001\n    pendingStates.forEach((partialState) => {\n      if (typeof partialState === "function") {\n        partialState = partialState(state)\n      }\n      state = {...state, ...partialState}\n    })\n    // \u6e05\u7a7a\u6570\u7ec4\n    pendingStates.length = 0;\n    return state;\n  }\n}\n\nfunction shouldUpdate(classInstance, nextState) {\n  classInstance.state = nextState\n  classInstance.forceUpdate();\n}\n\nexport class Component {\n  static isReactComponent = true\n  constructor(props) {\n    this.props = props\n    this.state = {}\n    this.updater = new Updater(this)\n  }\n  setState(partialState) {\n    this.updater.addState(partialState)\n  }\n  // \u8ba9\u7c7b\u7ec4\u4ef6\u5f3a\u884c\u66f4\u65b0\n  forceUpdate() {\n    // \u83b7\u53d6\u6b64\u7ec4\u4ef6\u4e0a\u4e00\u6b21 render \u6e32\u67d3\u51fa\u6765\u7684\u865a\u62df DOM\n    let oldRenderVdom = this.oldRenderVdom;\n    // \u83b7\u53d6\u865a\u62dfDOM\u5bf9\u5e94\u7684\u771f\u5b9eDOM oldRenderVdom.dom\n    let oldDOM = findDOM(oldRenderVdom)\n    // \u91cd\u65b0\u6267\u884c render \u5f97\u5230\u65b0\u7684\u865a\u62dfDOM\n    let newRenderVdom = this.render()\n    // \u628a\u8001\u5f97\u865a\u62dfDOM\u548c\u65b0\u7684\u865a\u62dfDOM\u8fdb\u884c\u5bf9\u6bd4\uff0c\u5bf9\u6bd4\u5f97\u5230\u7684\u5dee\u5f02\u66f4\u65b0\u5230\u771f\u5b9eDOM\n    compareTwoVdom(oldDOM.parentNode, oldRenderVdom, newRenderVdom)\n    this.oldRenderVdom = newRenderVdom\n  }\n}',lang:"diff"})))}));t["default"]=e=>{var t=s.a.useContext(l["context"]),n=t.demos;return s.a.useEffect((()=>{var t;null!==e&&void 0!==e&&null!==(t=e.location)&&void 0!==t&&t.hash&&l["AnchorLink"].scrollToAnchor(decodeURIComponent(e.location.hash.slice(1)))}),[]),s.a.createElement(o,{demos:n})}}}]);